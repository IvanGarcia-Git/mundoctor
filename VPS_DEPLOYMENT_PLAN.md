# MunDoctor VPS Deployment Plan

## 🎯 Overview

This comprehensive deployment plan provides step-by-step instructions for deploying the MunDoctor healthcare platform on a Hostinger VPS using Docker, Traefik, and DonDominio DNS configuration with the main domain **todostore.es**.

## 📋 Prerequisites

- **VPS**: Hostinger VPS with Ubuntu 22.04 LTS
- **Domain**: DonDominio domain configured for `todostore.es`
- **Docker**: Docker & Docker Compose installed
- **Subdomains**: DNS records for `api.todostore.es`, `db.todostore.es`, `traefik.todostore.es`

## 🔧 Phase 1: VPS Preparation

### 1.1 System Update & Docker Installation

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install Docker CE
curl -fsSL https://get.docker.com | sh

# Install Docker Compose plugin
sudo apt-get install docker-compose-plugin -y

# Add user to docker group
sudo usermod -aG docker $USER

# Restart to apply group changes
sudo reboot
```

### 1.2 Security Configuration

```bash
# Configure UFW firewall
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw --force enable

# Optional: Change default SSH port (recommended)
sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
sudo systemctl restart sshd
sudo ufw allow 2222/tcp
sudo ufw delete allow 22/tcp
```

### 1.3 Directory Structure Setup

```bash
# Create project directory
mkdir -p /opt/mundoctor
cd /opt/mundoctor

# Create necessary directories
mkdir -p traefik/{acme,dynamic}
mkdir -p logs
mkdir -p backups

# Set proper permissions
sudo chown -R $USER:$USER /opt/mundoctor
chmod 600 traefik/acme  # Secure ACME directory
```

## 🌐 Phase 2: DNS Configuration

### 2.1 DonDominio DNS Records

Configure the following DNS records in your DonDominio panel:

```
# Main domain
todostore.es.     A    YOUR_VPS_IP

# Subdomains
api.todostore.es.     A    YOUR_VPS_IP
db.todostore.es.      A    YOUR_VPS_IP
traefik.todostore.es. A    YOUR_VPS_IP
```

### 2.2 DNS Propagation Verification

```bash
# Check DNS propagation
dig todostore.es
dig api.todostore.es
dig db.todostore.es
dig traefik.todostore.es
```

## ⚙️ Phase 3: Configuration Files Setup

### 3.1 Environment Variables

Create production environment file:

```bash
# Copy and customize environment variables
cp .env.prod .env

# Edit with your actual values
nano .env
```

**Required environment variables:**
```bash
# Database
DATABASE_URL=postgresql://mundoctor_user:SECURE_PASSWORD@postgres:5432/mundoctor_prod
POSTGRES_USER=mundoctor_user
POSTGRES_PASSWORD=SECURE_PASSWORD
POSTGRES_DB=mundoctor_prod

# Redis
REDIS_PASSWORD=SECURE_REDIS_PASSWORD

# Clerk Authentication
CLERK_SECRET_KEY=sk_live_YOUR_CLERK_SECRET
VITE_CLERK_PUBLISHABLE_KEY=pk_live_YOUR_CLERK_PUBLISHABLE

# Stripe
STRIPE_SECRET_KEY=sk_live_YOUR_STRIPE_SECRET
STRIPE_WEBHOOK_SECRET=whsec_YOUR_STRIPE_WEBHOOK

# Email (SMTP)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password

# Twilio SMS
TWILIO_ACCOUNT_SID=your_twilio_sid
TWILIO_AUTH_TOKEN=your_twilio_token
TWILIO_PHONE_NUMBER=your_twilio_number
```

### 3.2 Traefik Configuration

The Traefik configuration is already set up correctly. Verify files exist:

```bash
# Check Traefik configuration
ls -la traefik/
cat traefik/traefik.yml
cat traefik/dynamic/dashboard-auth.yml
```

### 3.3 Create ACME Certificate Storage

```bash
# Create and secure ACME certificate file
touch traefik/acme/acme.json
chmod 600 traefik/acme/acme.json
```

## 🚀 Phase 4: Docker Services Deployment

### 4.1 Pre-deployment Checks

```bash
# Verify Docker installation
docker --version
docker compose version

# Check available disk space
df -h

# Verify environment variables
cat .env | grep -v "^#" | grep -v "^$"
```

### 4.2 Database Initialization

```bash
# Create database volume
docker volume create postgres_data
docker volume create redis_data

# Pull required images
docker compose pull
```

### 4.3 Service Deployment

```bash
# Deploy services in stages
# Stage 1: Core infrastructure
docker compose up -d traefik postgres redis

# Wait for services to be ready
sleep 30

# Stage 2: Application services
docker compose up -d backend frontend

# Stage 3: Management tools
docker compose up -d adminer
```

### 4.4 Deployment Verification

```bash
# Check running containers
docker compose ps

# Check logs
docker compose logs traefik
docker compose logs postgres
docker compose logs backend
docker compose logs frontend

# Check certificate generation
docker compose logs traefik | grep -i "cert"
```

## 🔒 Phase 5: SSL/TLS Configuration

### 5.1 Let's Encrypt Certificate Generation

Certificates will be automatically generated by Traefik. Monitor the process:

```bash
# Monitor certificate generation
docker compose logs -f traefik | grep -E "(cert|acme|challenge)"

# Check certificate status
ls -la traefik/acme/
```

### 5.2 HTTPS Verification

```bash
# Test HTTPS endpoints
curl -I https://todostore.es
curl -I https://api.todostore.es/health
curl -I https://traefik.todostore.es

# Check SSL certificate details
openssl s_client -connect todostore.es:443 -servername todostore.es
```

## 📊 Phase 6: Database Setup

### 6.1 Database Migration

```bash
# Run database migrations
docker compose exec backend npm run migrate

# Verify database tables
docker compose exec postgres psql -U mundoctor_user -d mundoctor_prod -c "\dt"
```

### 6.2 Initial Data Setup

```bash
# Seed initial data (if needed)
docker compose exec backend npm run seed

# Create admin user (if required)
docker compose exec backend npm run create-admin
```

## 🧪 Phase 7: Testing & Validation

### 7.1 Health Checks

```bash
# Test API endpoints
curl https://api.todostore.es/health
curl https://api.todostore.es/api/health

# Test database connectivity
docker compose exec backend npm run test-db
```

### 7.2 Application Testing

1. **Frontend Access**: https://todostore.es
2. **API Health**: https://api.todostore.es/health
3. **Database Admin**: https://db.todostore.es
4. **Traefik Dashboard**: https://traefik.todostore.es

### 7.3 Load Testing

```bash
# Install Apache Bench (optional)
sudo apt install apache2-utils

# Basic load test
ab -n 100 -c 10 https://todostore.es/
```

## 🔄 Phase 8: Monitoring & Maintenance

### 8.1 Log Management

```bash
# Setup log rotation
sudo nano /etc/logrotate.d/mundoctor

# Configure log monitoring
docker compose logs --tail=100 -f
```

### 8.2 Backup Strategy

```bash
# Create backup script
cat > /opt/mundoctor/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/mundoctor/backups"

# Database backup
docker compose exec postgres pg_dump -U mundoctor_user mundoctor_prod > "$BACKUP_DIR/db_backup_$DATE.sql"

# Volume backup
docker run --rm -v postgres_data:/data -v $BACKUP_DIR:/backup alpine tar czf /backup/postgres_volume_$DATE.tar.gz /data

# Clean old backups (keep last 7 days)
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
EOF

chmod +x /opt/mundoctor/backup.sh

# Setup cron job
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/mundoctor/backup.sh") | crontab -
```

### 8.3 Update Strategy

```bash
# Create update script
cat > /opt/mundoctor/update.sh << 'EOF'
#!/bin/bash
cd /opt/mundoctor

# Backup before update
./backup.sh

# Pull latest images
docker compose pull

# Update services with zero downtime
docker compose up -d --no-deps frontend
docker compose up -d --no-deps backend

# Verify services
docker compose ps
EOF

chmod +x /opt/mundoctor/update.sh
```

## 🚨 Phase 9: Troubleshooting

### 9.1 Common Issues

**Issue**: Certificate generation fails
```bash
# Check DNS propagation
dig todostore.es
# Check firewall
sudo ufw status
# Check Traefik logs
docker compose logs traefik
```

**Issue**: Database connection issues
```bash
# Check database logs
docker compose logs postgres
# Test connection
docker compose exec backend npm run test-db
```

**Issue**: Service unavailable
```bash
# Check all services
docker compose ps
# Check specific service logs
docker compose logs [service_name]
```

### 9.2 Useful Commands

```bash
# Restart specific service
docker compose restart [service_name]

# View real-time logs
docker compose logs -f [service_name]

# Execute commands in containers
docker compose exec [service_name] [command]

# Check resource usage
docker stats

# Clean up unused resources
docker system prune -a
```

## 📚 Phase 10: Documentation & References

### 10.1 Service URLs

- **Main Application**: https://todostore.es
- **API Endpoint**: https://api.todostore.es
- **Database Admin**: https://db.todostore.es
- **Traefik Dashboard**: https://traefik.todostore.es

### 10.2 Default Credentials

- **Traefik Dashboard**: admin/admin
- **Database Admin**: mundoctor_user/[your_password]

### 10.3 Important Files

- **Docker Compose**: `/opt/mundoctor/docker-compose.yml`
- **Environment**: `/opt/mundoctor/.env`
- **Traefik Config**: `/opt/mundoctor/traefik/traefik.yml`
- **SSL Certificates**: `/opt/mundoctor/traefik/acme/acme.json`
- **Database Data**: Docker volume `postgres_data`
- **Logs**: `/opt/mundoctor/logs/`

### 10.4 Security Considerations

1. **Change default passwords** immediately after deployment
2. **Enable firewall** and allow only necessary ports
3. **Regular security updates** for the VPS
4. **SSL certificate monitoring** for expiration
5. **Regular backups** and test restoration procedures
6. **Monitor logs** for suspicious activities
7. **Keep Docker images updated** regularly

## ✅ Deployment Checklist

- [ ] VPS prepared and secured
- [ ] DNS records configured and propagated
- [ ] Environment variables set
- [ ] Docker and Docker Compose installed
- [ ] Services deployed successfully
- [ ] SSL certificates generated
- [ ] Database migrated and seeded
- [ ] All endpoints accessible via HTTPS
- [ ] Health checks passing
- [ ] Monitoring and logging configured
- [ ] Backup strategy implemented
- [ ] Documentation updated

## 🎉 Conclusion

Your MunDoctor healthcare platform is now successfully deployed on your Hostinger VPS with:

- **Automatic HTTPS** via Let's Encrypt
- **Reverse proxy** with Traefik
- **Database persistence** with PostgreSQL
- **Caching** with Redis
- **Monitoring** and health checks
- **Backup strategy** for data protection

The deployment is production-ready and follows healthcare industry best practices for security and compliance.

---

*Generated with Claude Code - VPS Deployment Plan for MunDoctor Healthcare Platform*